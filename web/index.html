<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BratenDreher Control</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTE2IDJMMjQgMTZMMTYgMzBMOCAxNkwxNiAyWiIgZmlsbD0iIzMzNzNkYyIvPgo8L3N2Zz4K">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üîÑ BratenDreher</h1>
            <p class="subtitle">Stepper Motor Control via Bluetooth</p>
        </header>

        <!-- Connection Status -->
        <div class="card connection-card">
            <div class="connection-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="connectionStatus">Disconnected</span>
            </div>
            <div class="connection-info">
                <small id="connectionInfo">Click Connect to start</small>
            </div>
            <div class="connection-buttons">
                <button id="connectBtn" class="btn btn-primary">
                    üì∂ Connect
                </button>
                <button id="reconnectBtn" class="btn btn-secondary" disabled>
                    üîÑ Reconnect/Retry
                </button>
                <button id="disconnectBtn" class="btn btn-secondary" disabled>
                    ‚ùå Disconnect
                </button>
            </div>
        </div>

        <!-- Motor Control -->
        <div class="card control-card">
            <h2>Motor Control</h2>
            
            <!-- Enable/Disable -->
            <div class="control-group">
                <label class="control-label">Motor Status</label>
                <div class="toggle-switch">
                    <input type="checkbox" id="motorToggle" class="toggle-input">
                    <label for="motorToggle" class="toggle-label">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text-off">OFF</span>
                        <span class="toggle-text-on">ON</span>
                    </label>
                </div>
            </div>

            <!-- Speed Control -->
            <div class="control-group">
                <label class="control-label" for="speedSlider">
                    Speed: <span id="speedValue">1.0</span> RPM
                </label>
                <div class="speed-slider-container">
                    <div class="speed-slider-wrapper">
                        <div class="speed-slider-fill" id="speedSliderFill"></div>
                        <input type="range" 
                               id="speedSlider" 
                               class="speed-slider"
                               min="0.1" 
                               max="30" 
                               step="0.1" 
                               value="1.0">
                    </div>
                </div>
                <div class="speed-presets">
                    <button class="preset-btn" data-speed="0.5">Very Slow</button>
                    <button class="preset-btn" data-speed="2.0">Slow</button>
                    <button class="preset-btn" data-speed="10.0">Medium</button>
                    <button class="preset-btn" data-speed="30.0">Fast</button>
                </div>
            </div>

            <!-- Direction Control -->
            <div class="control-group">
                <label class="control-label">Direction</label>
                <div class="direction-buttons">
                    <button id="clockwiseBtn" class="btn btn-direction active" data-direction="1">
                        ‚Üª Clockwise
                    </button>
                    <button id="counterclockwiseBtn" class="btn btn-direction" data-direction="0">
                        ‚Ü∫ Counter-clockwise
                    </button>
                </div>
            </div>

            <!-- Emergency Stop -->
            <div class="control-group">
                <button id="emergencyStopBtn" class="btn btn-emergency">
                    üõë Emergency Stop
                </button>
            </div>

            <!-- Variable Speed Settings -->
            <div class="control-group variable-speed-settings">
                <h3>Variable Speed</h3>
                <p class="setting-description">
                    üîÑ For uneven cooking compensation - create a slow zone to give pale areas more time to brown while maintaining the same average cooking time
                </p>
                
                <div class="toggle-switch">
                    <input type="checkbox" id="variableSpeedToggle" class="toggle-input">
                    <label for="variableSpeedToggle" class="toggle-label">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text-off">OFF</span>
                        <span class="toggle-text-on">ON</span>
                    </label>
                </div>
                
                <div class="variable-speed-controls" id="variableSpeedControls">
                    <div class="setting-item">
                        <label for="strengthSlider">Variation Strength: <span id="strengthValue">20</span>%</label>
                        <input type="range" 
                               id="strengthSlider" 
                               class="setting-slider"
                               min="0" 
                               max="100" 
                               step="5" 
                               value="20">
                        <small class="setting-hint">How much speed varies from fastest to slowest point</small>
                    </div>
                    <div class="setting-item">
                        <label for="phaseSlider">Phase Offset: <span id="phaseValue">0</span>¬∞</label>
                        <input type="range" 
                               id="phaseSlider" 
                               class="setting-slider"
                               min="-180" 
                               max="180" 
                               step="15" 
                               value="0">
                        <small class="setting-hint">Rotate the slow zone to the desired position</small>
                    </div>
                    <div class="variable-speed-info">
                        <small>üí° Position your rotisserie so the pale side is at the current position, then enable variable speed. This position will become the slowest point in the rotation cycle.</small>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings -->
            <div class="control-group advanced-settings">
                <h3>Advanced Settings</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="currentSlider">Current: <span id="currentValue">30</span>%</label>
                        <input type="range" 
                               id="currentSlider" 
                               class="setting-slider"
                               min="10" 
                               max="100" 
                               step="5" 
                               value="30">
                    </div>
                    <div class="setting-item">
                        <label for="accelerationTimeSlider">Acceleration Time: <span id="accelerationTimeValue">5</span>s</label>
                        <input type="range" 
                               id="accelerationTimeSlider" 
                               class="setting-slider"
                               min="1" 
                               max="30" 
                               step="1" 
                               value="5">
                        <small class="setting-hint">Time to reach maximum speed (30 RPM) from stop</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Display -->
        <div class="card stats-card">
            <h2>Statistics</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="totalRevolutions">0.000</span>
                    <span class="stat-label">Total Revolutions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="runTime">00:00:00.000</span>
                    <span class="stat-label">Running Time</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="avgSpeed">0.000</span>
                    <span class="stat-label">Avg Speed (RPM)</span>
                </div>
            </div>
            <div class="stats-buttons">
                <button id="resetStatsBtn" class="btn btn-secondary stats-reset">
                    üìä Reset Statistics
                </button>
            </div>
        </div>

        <!-- Power Delivery Status -->
        <div class="card power-card">
            <h2>‚ö° Power Delivery</h2>
            <div class="power-status">
                <div class="power-status-grid">
                    <div class="power-item">
                        <span class="power-label">Status:</span>
                        <span id="pdStatus" class="power-value status-unknown">Unknown</span>
                    </div>
                    <div class="power-item">
                        <span class="power-label">Power Good:</span>
                        <span id="pdPowerGood" class="power-value status-unknown">Unknown</span>
                    </div>
                    <div class="power-item">
                        <span class="power-label">Negotiated:</span>
                        <span id="pdNegotiatedVoltage" class="power-value">- V</span>
                    </div>
                    <div class="power-item">
                        <span class="power-label">Current:</span>
                        <span id="pdCurrentVoltage" class="power-value">- V</span>
                    </div>
                </div>
                <div class="power-controls">
                    <label for="voltageSelect">Target Voltage:</label>
                    <select id="voltageSelect" class="voltage-select">
                        <option value="5">5V</option>
                        <option value="9">9V</option>
                        <option value="12" selected>12V</option>
                        <option value="15">15V</option>
                        <option value="20">20V</option>
                    </select>
                    <button id="negotiateBtn" class="btn btn-secondary">
                        üîå Renegotiate
                    </button>
                    <button id="autoNegotiateBtn" class="btn btn-primary">
                        ‚ö° Auto-Negotiate Highest Power
                    </button>
                </div>
            </div>
        </div>

        <!-- Stall Detection -->
        <div class="card stall-card">
            <h2>Stall Detection</h2>
            <div class="stall-content">
                <div class="stall-info">
                    <p>TMC2209 StallGuard monitors motor load and detects when the motor cannot turn due to excessive resistance.</p>
                </div>
                
                <!-- StallGuard Threshold Control -->
                <div class="control-group stallguard-settings">
                    <h3>StallGuard Threshold & Load Monitor</h3>
                    <div class="control-item">
                        <label for="stallguardThresholdSlider">
                            Sensitivity: <span id="stallguardThresholdValue">32</span> | Current Load: <span id="stallguardResultValue">255</span>
                        </label>
                        <div class="stallguard-slider-container">
                            <div class="stallguard-slider-wrapper">
                                <div class="stallguard-slider-fill" id="stallguardSliderFill"></div>
                                <input type="range" 
                                       id="stallguardThresholdSlider" 
                                       class="stallguard-slider"
                                       min="0" 
                                       max="63" 
                                       step="1" 
                                       value="32">
                            </div>
                        </div>
                        <div class="stallguard-labels">
                            <span class="stallguard-label-left">More Sensitive (0)</span>
                            <span class="stallguard-label-right">Less Sensitive (63)</span>
                        </div>
                        <small class="setting-hint">Green fill shows current motor load (0-510 range). Adjust slider to set stall sensitivity. Stall occurs when load drops below threshold√ó2.</small>
                    </div>
                </div>
                
                <div class="stall-status-grid">
                    <div class="stall-status-item">
                        <span class="status-label">Stall Status:</span>
                        <span id="stallStatus" class="status-value">OK</span>
                    </div>
                    <div class="stall-status-item">
                        <span class="status-label">Stall Count:</span>
                        <span id="stallCount" class="status-value">0</span>
                    </div>
                </div>
                <div class="stall-actions">
                    <button id="resetStallBtn" class="btn btn-warning">
                        ‚ö†Ô∏è Reset Stall Count
                    </button>
                </div>
                <div class="stall-help">
                    <small><em>üí° If stalls occur frequently, try reducing speed, increasing threshold, or checking for mechanical obstructions.</em></small>
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div class="card status-card">
            <h2>Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Motor:</span>
                    <span id="motorStatus" class="status-value">Stopped</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Direction:</span>
                    <span id="currentDirection" class="status-value">Clockwise</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Setpoint RPM:</span>
                    <span id="setpointSpeed" class="status-value">0.0 RPM</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current RPM:</span>
                    <span id="currentSpeed" class="status-value">0.0 RPM</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Variable Speed:</span>
                    <span id="variableSpeedStatus" class="status-value">OFF</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Acceleration:</span>
                    <span id="currentAcceleration" class="status-value">5.0s to max</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current:</span>
                    <span id="currentCurrent" class="status-value">30%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">TMC2209:</span>
                    <span id="tmc2209Status" class="status-value">Unknown</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Temperature:</span>
                    <span id="tmc2209Temperature" class="status-value">Normal</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Update:</span>
                    <span id="lastUpdate" class="status-value">Never</span>
                </div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card info-card">
            <h2>Info</h2>
            <div class="info-content">
                <p><strong>Motor:</strong> NEMA 17 Stepper (FastAccelStepper + TMC2209)</p>
                <p><strong>Gear Ratio:</strong> 1:10</p>
                <p><strong>Speed Range:</strong> 0.1 - 30.0 RPM (0.5 RPS max)</p>
                <p><strong>Steps per Revolution:</strong> 2000 (200 * 10)</p>
                <p><strong>Max Torque:</strong> High due to gear reduction</p>
                <p><strong>Stall Detection:</strong> TMC2209 StallGuard monitors motor load</p>
                <p><em>Note: If stalls occur, reduce speed or check load</em></p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>BratenDreher Control Interface</p>
        <p class="version">Version 1.0</p>
    </footer>

    <script src="script.js"></script>
</body>
</html>
